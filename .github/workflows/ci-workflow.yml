name: CI Docker Build & Push

on:
  push:
    branches:
      - main
      - devops-final
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  VERSION_MAJOR: "1"
  VERSION_MINOR: "0"

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3. Log in DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # 4. Set image tag
      - name: Set image tag
        id: vars
        run: |
          RUN_NUMBER=${GITHUB_RUN_NUMBER}
          BRANCH_NAME=${GITHUB_REF##*/}
          if [[ "$BRANCH_NAME" == "main" ]]; then
            IMAGE_TAG="v${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.$RUN_NUMBER"
          else
            IMAGE_TAG="dev-v${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.$RUN_NUMBER"
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "Tag will be $IMAGE_TAG"

      # 6. Build & push spring-petclinic-config-server
      - name: Build & Push spring-petclinic-config-server
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_USERNAME }}/spring-petclinic-config-server"
          echo "Building $IMAGE_NAME:$IMAGE_TAG"
          docker build -t $IMAGE_NAME:$IMAGE_TAG ./spring-petclinic-config-server
          docker push $IMAGE_NAME:$IMAGE_TAG

      # 7. Log tag vÃ o deploy-log.md
      - name: Log image tag
        run: |
          echo "## Build $GITHUB_RUN_NUMBER - $(date)" >> deploy-log.md
          echo "- Branch: ${GITHUB_REF##*/}" >> deploy-log.md
          echo "- Image Tag: $IMAGE_TAG" >> deploy-log.md
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add deploy-log.md
          git commit -m "Add deploy log for run $GITHUB_RUN_NUMBER"
          git push
