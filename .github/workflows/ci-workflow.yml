name: CI Docker Build & Push

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [
          config-server,
          discovery-server,
          customers-service,
          visits-service,
          genai-service,
          api-gateway,
          admin-server,
          grafana-server,
          prometheus-server
        ]
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set image tag
      - name: Set image tag
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "IMAGE_TAG=v1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev-v1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      # 3. Login Docker Hub
      - name: Log in Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Build & push Docker image
      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ 
            matrix.service == 'config-server' && 'petclinic-app/spring-petclinic-config-server' ||
            matrix.service == 'discovery-server' && 'petclinic-app/spring-petclinic-discovery-server' ||
            matrix.service == 'customers-service' && 'petclinic-app/spring-petclinic-customers-service' ||
            matrix.service == 'visits-service' && 'petclinic-app/spring-petclinic-visits-service' ||
            matrix.service == 'genai-service' && 'petclinic-app/spring-petclinic-genai-service' ||
            matrix.service == 'api-gateway' && 'petclinic-app/spring-petclinic-api-gateway' ||
            matrix.service == 'admin-server' && 'petclinic-app/spring-petclinic-admin-server' ||
            matrix.service == 'grafana-server' && './docker/grafana' ||
            matrix.service == 'prometheus-server' && './docker/prometheus'
          }}
          file: ${{ 
            matrix.service == 'config-server' && 'petclinic-app/spring-petclinic-config-server/Dockerfile' ||
            matrix.service == 'discovery-server' && 'petclinic-app/spring-petclinic-discovery-server/Dockerfile' ||
            matrix.service == 'customers-service' && 'petclinic-app/spring-petclinic-customers-service/Dockerfile' ||
            matrix.service == 'visits-service' && 'petclinic-app/spring-petclinic-visits-service/Dockerfile' ||
            matrix.service == 'genai-service' && 'petclinic-app/spring-petclinic-genai-service/Dockerfile' ||
            matrix.service == 'api-gateway' && 'petclinic-app/spring-petclinic-api-gateway/Dockerfile' ||
            matrix.service == 'admin-server' && 'petclinic-app/spring-petclinic-admin-server/Dockerfile' ||
            matrix.service == 'grafana-server' && './docker/grafana/Dockerfile' ||
            matrix.service == 'prometheus-server' && './docker/prometheus/Dockerfile'
          }}
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest
          cache-to: type=inline

      # 5. Record deployed tag (chỉ 1 lần)
      - name: Record deployed tag
        if: matrix.service == 'config-server'
        run: |
          echo "- $IMAGE_TAG" >> deploy-log.md
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add deploy-log.md
          git commit -m "chore: log deployed image tag $IMAGE_TAG [skip ci]"
          git push
