name: CI Docker Build & Push

on:
  push:
    branches:
      - main
      - devops-final
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [
          config-server,
          discovery-server,
          customers-service,
          visits-service,
          genai-service,
          api-gateway,
          admin-server,
          grafana-server,
          prometheus-server
        ]
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set image tag
      - name: Set image tag
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "IMAGE_TAG=v1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev-v1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          fi

      # 3. Login Docker Hub
      - name: Log in Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Set Docker context and Dockerfile
      - name: Set Docker context and Dockerfile
        run: |
          case "${{ matrix.service }}" in
            config-server)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-config-server" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-config-server/Dockerfile" >> $GITHUB_ENV
              ;;
            discovery-server)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-discovery-server" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-discovery-server/Dockerfile" >> $GITHUB_ENV
              ;;
            customers-service)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-customers-service" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-customers-service/Dockerfile" >> $GITHUB_ENV
              ;;
            visits-service)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-visits-service" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-visits-service/Dockerfile" >> $GITHUB_ENV
              ;;
            genai-service)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-genai-service" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-genai-service/Dockerfile" >> $GITHUB_ENV
              ;;
            api-gateway)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-api-gateway" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-api-gateway/Dockerfile" >> $GITHUB_ENV
              ;;
            admin-server)
              echo "DOCKER_CONTEXT=petclinic-app/spring-petclinic-admin-server" >> $GITHUB_ENV
              echo "DOCKER_FILE=petclinic-app/spring-petclinic-admin-server/Dockerfile" >> $GITHUB_ENV
              ;;
            grafana-server)
              echo "DOCKER_CONTEXT=./docker/grafana" >> $GITHUB_ENV
              echo "DOCKER_FILE=./docker/grafana/Dockerfile" >> $GITHUB_ENV
              ;;
            prometheus-server)
              echo "DOCKER_CONTEXT=./docker/prometheus" >> $GITHUB_ENV
              echo "DOCKER_FILE=./docker/prometheus/Dockerfile" >> $GITHUB_ENV
              ;;
          esac

      # 5. Build & push Docker image
      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.DOCKER_CONTEXT }}
          file: ${{ env.DOCKER_FILE }}
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest
          cache-to: type=inline

      # 6. Record deployed tag (chỉ 1 lần)
      - name: Record deployed tag
        if: matrix.service == 'config-server'
        run: |
          echo "- $IMAGE_TAG" >> deploy-log.md
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add deploy-log.md
          git commit -m "chore: log deployed image tag $IMAGE_TAG [skip ci]"
          git push
